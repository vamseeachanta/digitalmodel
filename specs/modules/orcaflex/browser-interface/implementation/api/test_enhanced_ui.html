<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrcaFlex Enhanced Time Traces UI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.4rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .result.error {
            border-left-color: #fc8181;
            background: #fff5f5;
        }
        
        .result.success {
            border-left-color: #48bb78;
            background: #f0fff4;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: #edf2f7;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 11px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
            margin-top: 5px;
        }
        
        .critical-banner {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .critical-banner h2 {
            margin-bottom: 15px;
            font-size: 1.8rem;
        }
        
        .critical-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .critical-item {
            background: rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .canvas-container {
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px;
        }
        
        canvas {
            width: 100%;
            height: 300px;
        }
        
        select {
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            font-size: 14px;
            margin-top: 10px;
            width: 100%;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-online {
            background: #48bb78;
            color: white;
        }
        
        .status-offline {
            background: #fc8181;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåä OrcaFlex Enhanced Time Traces Dashboard</h1>
        
        <div id="critical-banner" class="critical-banner" style="display:none;">
            <h2>‚ö†Ô∏è Critical Loading Case Detected</h2>
            <div class="critical-info" id="critical-info"></div>
        </div>
        
        <div class="dashboard">
            <!-- API Status -->
            <div class="card">
                <h2>API Status <span id="api-status" class="status-badge status-offline">OFFLINE</span></h2>
                <div class="btn-group">
                    <button onclick="checkStatus()">Check Status</button>
                    <button onclick="runFullAnalysis()">Run Full Analysis</button>
                </div>
                <div id="status-result" class="result" style="display:none;"></div>
            </div>
            
            <!-- All Struts Time Traces -->
            <div class="card">
                <h2>All Struts Time Traces</h2>
                <div class="btn-group">
                    <button onclick="getAllStrutTraces()">Get All Struts</button>
                    <button onclick="plotAllStruts()">Plot Struts</button>
                </div>
                <div class="loader" id="struts-loader"></div>
                <div id="struts-result" class="result" style="display:none;"></div>
                <canvas id="struts-chart" style="display:none;"></canvas>
            </div>
            
            <!-- Jacket Forces & Moments -->
            <div class="card">
                <h2>Jacket Forces & Moments</h2>
                <select id="jacket-location">
                    <option value="base">Base</option>
                    <option value="top">Top</option>
                    <option value="mid">Mid</option>
                </select>
                <div class="btn-group">
                    <button onclick="getJacketData()">Get Jacket Data</button>
                    <button onclick="plotJacketForces()">Plot Forces</button>
                </div>
                <div id="jacket-result" class="result" style="display:none;"></div>
                <canvas id="jacket-chart" style="display:none;"></canvas>
            </div>
            
            <!-- Comparative Analysis -->
            <div class="card">
                <h2>Comparative Analysis</h2>
                <div class="btn-group">
                    <button onclick="compareLoadCases()">Compare Cases</button>
                    <button onclick="plotComparison()">Plot Comparison</button>
                </div>
                <div id="compare-result" class="result" style="display:none;"></div>
                <canvas id="compare-chart" style="display:none;"></canvas>
            </div>
            
            <!-- Statistical Analysis -->
            <div class="card">
                <h2>Statistical Analysis</h2>
                <div class="btn-group">
                    <button onclick="getStatistics()">Get Statistics</button>
                    <button onclick="showDetailedStats()">Detailed Stats</button>
                </div>
                <div id="stats-result" class="result" style="display:none;"></div>
                <div class="stats-grid" id="stats-grid" style="display:none;"></div>
            </div>
            
            <!-- Export Options -->
            <div class="card">
                <h2>Export Time Series</h2>
                <select id="export-format">
                    <option value="csv">CSV</option>
                    <option value="json">JSON</option>
                    <option value="excel">Excel</option>
                    <option value="matlab">MATLAB</option>
                </select>
                <div class="btn-group">
                    <button onclick="exportData()">Export Data</button>
                    <button onclick="exportWithStats()">Export with Stats</button>
                </div>
                <div id="export-result" class="result" style="display:none;"></div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const API_BASE = 'http://localhost:8001';
        let criticalCase = null;
        let allStrutsData = null;
        let jacketData = null;
        
        // Check status on load
        window.onload = () => {
            checkStatus();
        };
        
        async function checkStatus() {
            const statusEl = document.getElementById('api-status');
            const resultEl = document.getElementById('status-result');
            
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                
                statusEl.textContent = 'ONLINE';
                statusEl.className = 'status-badge status-online';
                
                resultEl.style.display = 'block';
                resultEl.className = 'result success';
                resultEl.textContent = `API Version: ${data.version}\nBase Path: ${data.base_path}\nEnhanced Endpoints Available: ${Object.keys(data.endpoints.enhanced_timeseries).length}`;
                
                // Get critical case
                getCriticalCase();
            } catch (error) {
                statusEl.textContent = 'OFFLINE';
                statusEl.className = 'status-badge status-offline';
                resultEl.style.display = 'block';
                resultEl.className = 'result error';
                resultEl.textContent = `Error: ${error.message}`;
            }
        }
        
        async function getCriticalCase() {
            try {
                const response = await fetch(`${API_BASE}/api/critical`);
                criticalCase = await response.json();
                
                if (criticalCase) {
                    displayCriticalCase(criticalCase);
                }
            } catch (error) {
                console.error('Failed to get critical case:', error);
            }
        }
        
        function displayCriticalCase(critical) {
            const banner = document.getElementById('critical-banner');
            const info = document.getElementById('critical-info');
            
            banner.style.display = 'block';
            info.innerHTML = `
                <div class="critical-item">
                    <div class="stat-label">Maximum Tension</div>
                    <div class="stat-value">${critical.value.toFixed(2)} kN</div>
                </div>
                <div class="critical-item">
                    <div class="stat-label">Critical Strut</div>
                    <div class="stat-value">${critical.strut.toUpperCase()}</div>
                </div>
                <div class="critical-item">
                    <div class="stat-label">LNG Loading</div>
                    <div class="stat-value">${critical.metadata.lng_loading || 'N/A'}</div>
                </div>
                <div class="critical-item">
                    <div class="stat-label">Direction</div>
                    <div class="stat-value">${critical.metadata.direction || 'N/A'}</div>
                </div>
            `;
        }
        
        async function runFullAnalysis() {
            const resultEl = document.getElementById('status-result');
            resultEl.style.display = 'block';
            resultEl.className = 'result';
            resultEl.textContent = 'Running full analysis...';
            
            try {
                const response = await fetch(`${API_BASE}/api/analyze`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        file_pattern: "dm_*_strut_dyn.csv",
                        max_files: 20,
                        force_refresh: true
                    })
                });
                
                const data = await response.json();
                resultEl.className = 'result success';
                resultEl.textContent = `Analysis Complete!\nFiles: ${data.files_analyzed}\nStruts: ${data.struts_found}\nMax: ${data.absolute_max.toFixed(2)} kN`;
                
                if (data.critical_case) {
                    criticalCase = data.critical_case;
                    displayCriticalCase(criticalCase);
                }
            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `Error: ${error.message}`;
            }
        }
        
        async function getAllStrutTraces() {
            if (!criticalCase) {
                alert('Please run analysis first to identify critical case');
                return;
            }
            
            const resultEl = document.getElementById('struts-result');
            const loader = document.getElementById('struts-loader');
            
            resultEl.style.display = 'block';
            loader.style.display = 'block';
            resultEl.className = 'result';
            resultEl.textContent = 'Loading all strut traces...';
            
            try {
                const fe_file = criticalCase.fe_filename.split('/').pop();
                const response = await fetch(`${API_BASE}/api/v2/timeseries/struts/${fe_file}/all?downsample=50`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                allStrutsData = await response.json();
                
                resultEl.className = 'result success';
                let output = `Strut Time Traces for ${fe_file}\n`;
                output += `Time Range: ${allStrutsData.time_range.start.toFixed(1)}s - ${allStrutsData.time_range.end.toFixed(1)}s\n`;
                output += `Total Struts: ${allStrutsData.statistics.total_struts}\n`;
                output += `Global Max: ${allStrutsData.statistics.global_max.toFixed(2)} kN\n`;
                output += `Critical Strut: ${allStrutsData.statistics.critical_strut}\n\n`;
                
                allStrutsData.struts.forEach(strut => {
                    output += `${strut.strut_id}: Max=${strut.max_value.toFixed(2)} @ t=${strut.max_time.toFixed(1)}s\n`;
                });
                
                resultEl.textContent = output;
            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `Error: ${error.message}`;
            } finally {
                loader.style.display = 'none';
            }
        }
        
        async function getJacketData() {
            if (!criticalCase) {
                alert('Please run analysis first');
                return;
            }
            
            const location = document.getElementById('jacket-location').value;
            const resultEl = document.getElementById('jacket-result');
            
            resultEl.style.display = 'block';
            resultEl.className = 'result';
            resultEl.textContent = 'Loading jacket data...';
            
            try {
                const fe_file = criticalCase.fe_filename.split('/').pop();
                const response = await fetch(`${API_BASE}/api/v2/timeseries/jacket/${fe_file}?location=${location}&downsample=50`);
                
                jacketData = await response.json();
                
                resultEl.className = 'result success';
                let output = `Jacket Data at ${location.toUpperCase()}\n`;
                output += `Time Range: ${jacketData.time_range.start.toFixed(1)}s - ${jacketData.time_range.end.toFixed(1)}s\n\n`;
                
                output += 'Forces (kN):\n';
                Object.entries(jacketData.forces).forEach(([axis, stats]) => {
                    output += `  ${axis.toUpperCase()}: Max=${stats.max.toFixed(2)}, RMS=${stats.rms.toFixed(2)}\n`;
                });
                
                output += '\nMoments (kN.m):\n';
                Object.entries(jacketData.moments).forEach(([axis, stats]) => {
                    output += `  ${axis.toUpperCase()}: Max=${stats.max.toFixed(2)}, RMS=${stats.rms.toFixed(2)}\n`;
                });
                
                resultEl.textContent = output;
            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `Error: ${error.message}`;
            }
        }
        
        async function getStatistics() {
            if (!criticalCase) {
                alert('Please run analysis first');
                return;
            }
            
            const resultEl = document.getElementById('stats-result');
            resultEl.style.display = 'block';
            resultEl.className = 'result';
            resultEl.textContent = 'Calculating statistics...';
            
            try {
                const fe_file = criticalCase.fe_filename.split('/').pop();
                const response = await fetch(`${API_BASE}/api/v2/timeseries/statistics/${fe_file}/strut7_tension`);
                
                const stats = await response.json();
                
                resultEl.className = 'result success';
                let output = `Statistical Analysis for Strut 7\n`;
                output += `Peak Value: ${stats.peak_value.toFixed(2)} kN @ t=${stats.peak_time.toFixed(1)}s\n`;
                output += `Mean: ${stats.mean.toFixed(2)} kN\n`;
                output += `Std Dev: ${stats.std_dev.toFixed(2)} kN\n`;
                output += `RMS: ${stats.rms.toFixed(2)} kN\n`;
                output += `Range: ${stats.range.toFixed(2)} kN\n`;
                output += `Zero Crossings: ${stats.zero_crossings}\n`;
                output += `Dominant Frequency: ${stats.dominant_frequency.toFixed(3)} Hz\n`;
                output += `Fatigue Damage: ${stats.fatigue_damage.toFixed(2)}\n\n`;
                output += 'Percentiles:\n';
                Object.entries(stats.percentiles).forEach(([p, val]) => {
                    output += `  ${p}: ${val.toFixed(2)} kN\n`;
                });
                
                resultEl.textContent = output;
                
                // Show detailed stats grid
                showStatsGrid(stats);
            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `Error: ${error.message}`;
            }
        }
        
        function showStatsGrid(stats) {
            const grid = document.getElementById('stats-grid');
            grid.style.display = 'grid';
            grid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-label">Peak</div>
                    <div class="stat-value">${stats.peak_value.toFixed(0)}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Mean</div>
                    <div class="stat-value">${stats.mean.toFixed(0)}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">RMS</div>
                    <div class="stat-value">${stats.rms.toFixed(0)}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Freq (Hz)</div>
                    <div class="stat-value">${stats.dominant_frequency.toFixed(3)}</div>
                </div>
            `;
        }
        
        async function exportData() {
            if (!criticalCase) {
                alert('Please run analysis first');
                return;
            }
            
            const format = document.getElementById('export-format').value;
            const resultEl = document.getElementById('export-result');
            
            resultEl.style.display = 'block';
            resultEl.className = 'result';
            resultEl.textContent = `Exporting to ${format.toUpperCase()}...`;
            
            try {
                const fe_file = criticalCase.fe_filename.split('/').pop();
                const response = await fetch(`${API_BASE}/api/v2/timeseries/export/${fe_file}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        format: format,
                        include_statistics: true,
                        downsample_factor: 10
                    })
                });
                
                const result = await response.json();
                
                resultEl.className = 'result success';
                resultEl.textContent = `Export Complete!\nFormat: ${result.format}\nFile: ${result.file_path || 'Ready for download'}\nRows: ${result.rows_exported}\nColumns: ${result.columns_exported}`;
            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `Error: ${error.message}`;
            }
        }
        
        // Placeholder plotting functions
        function plotAllStruts() {
            if (!allStrutsData) {
                alert('Please load strut data first');
                return;
            }
            alert('Plotting functionality would display all strut traces on a chart');
        }
        
        function plotJacketForces() {
            if (!jacketData) {
                alert('Please load jacket data first');
                return;
            }
            alert('Plotting functionality would display jacket forces/moments');
        }
        
        function plotComparison() {
            alert('Plotting functionality would compare multiple load cases');
        }
        
        async function compareLoadCases() {
            alert('This would compare time traces from different loading conditions');
        }
        
        function showDetailedStats() {
            const grid = document.getElementById('stats-grid');
            if (grid.style.display === 'none' || !grid.style.display) {
                grid.style.display = 'grid';
            } else {
                grid.style.display = 'none';
            }
        }
        
        function exportWithStats() {
            exportData();
        }
    </script>
</body>
</html>