sequenceDiagram
    %% MarkItDown MCP Data Flow Sequence Diagram
    
    participant User as User/Claude CLI
    participant MCP as MCP Server<br/>(Port 3106)
    participant FastMCP as FastMCP Framework
    participant Conv as Document Converter
    participant MD as MarkItDown Library
    participant FS as File System
    participant LLM as LLM API<br/>(Optional)
    participant Cache as Cache<br/>(Optional)
    
    %% Document Conversion Flow
    Note over User, Cache: Single Document Conversion Flow
    
    User->>MCP: convert_document(file_path, options)
    MCP->>FastMCP: Route to tool handler
    FastMCP->>Conv: Process conversion request
    
    %% Check cache
    Conv->>Cache: Check if cached
    alt Document cached
        Cache-->>Conv: Return cached result
    else Not cached
        Conv->>FS: Read document file
        FS-->>Conv: File content
        Conv->>MD: Convert to Markdown
        
        %% Optional LLM enhancement
        opt LLM Enhancement Enabled
            MD->>LLM: Describe images/complex content
            LLM-->>MD: Enhanced descriptions
        end
        
        MD-->>Conv: Markdown content
        Conv->>Cache: Store in cache
    end
    
    Conv->>FS: Write output file (optional)
    Conv-->>FastMCP: Conversion result
    FastMCP-->>MCP: Format response
    MCP-->>User: Return markdown + metadata
    
    %% Batch Conversion Flow
    Note over User, Cache: Batch Document Conversion Flow
    
    User->>MCP: batch_convert(directory, pattern)
    MCP->>FastMCP: Route to batch handler
    FastMCP->>Conv: Process batch request
    
    Conv->>FS: List matching files
    FS-->>Conv: File list
    
    loop For each file (parallel)
        Conv->>Conv: convert_document(file)
        Note right of Conv: Reuses single<br/>conversion flow
    end
    
    Conv-->>FastMCP: Batch results
    FastMCP-->>MCP: Format batch response
    MCP-->>User: Return summary + file list
    
    %% Table Extraction Flow
    Note over User, Cache: Table Extraction Flow
    
    User->>MCP: extract_tables(file_path, format)
    MCP->>FastMCP: Route to extraction handler
    FastMCP->>Conv: Process extraction request
    
    Conv->>MD: Convert document
    MD-->>Conv: Markdown with tables
    Conv->>Conv: Parse table structures
    
    alt Format = CSV
        Conv->>Conv: Convert to CSV format
    else Format = JSON
        Conv->>Conv: Convert to JSON structure
    else Format = Markdown
        Conv->>Conv: Keep markdown tables
    end
    
    Conv-->>FastMCP: Extracted tables
    FastMCP-->>MCP: Format table response
    MCP-->>User: Return tables in requested format
    
    %% Resource Query Flow
    Note over User, Cache: Resource Query Flow
    
    User->>MCP: GET markitdown://capabilities
    MCP->>FastMCP: Route to resource handler
    FastMCP->>Conv: Get capabilities
    Conv-->>FastMCP: Feature list + versions
    FastMCP-->>MCP: Format resource response
    MCP-->>User: Return capabilities JSON
    
    %% History Tracking
    Note over User, Cache: All Operations Update History
    
    Conv->>Conv: Log operation
    Conv->>Conv: Update metrics
    Conv->>Conv: Store in history
    
    %% Error Handling Flow
    Note over User, Cache: Error Handling Flow
    
    User->>MCP: convert_document(invalid_file)
    MCP->>FastMCP: Route request
    FastMCP->>Conv: Process request
    Conv->>FS: Read file
    FS--xConv: File not found
    Conv->>Conv: Log error
    Conv-->>FastMCP: Error response
    FastMCP-->>MCP: Format error
    MCP-->>User: Return error with details