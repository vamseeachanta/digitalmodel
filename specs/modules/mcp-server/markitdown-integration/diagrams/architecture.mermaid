graph TB
    %% MarkItDown MCP Architecture Diagram
    
    subgraph "Client Layer"
        CLI[Claude CLI]
        API[API Clients]
        AGENTS[AI Agents]
    end
    
    subgraph "MCP Protocol Layer"
        MCP[MCP Server<br/>Port: 3106]
        
        subgraph "Resources"
            RES_CAP[markitdown://capabilities]
            RES_HIST[markitdown://history]
            RES_CFG[markitdown://config]
        end
        
        subgraph "Tools"
            TOOL_CONV[convert_document]
            TOOL_BATCH[batch_convert]
            TOOL_TABLE[extract_tables]
            TOOL_IMG[describe_image]
        end
        
        subgraph "Prompts"
            PROMPT_TECH[convert_technical_docs]
            PROMPT_TABLE[extract_data_tables]
            PROMPT_SCAN[process_scanned_documents]
        end
    end
    
    subgraph "FastMCP Framework"
        FASTMCP[FastMCP Server]
        ASYNC[Async Handler]
        ROUTER[Request Router]
    end
    
    subgraph "MarkItDown Core"
        CONVERTER[Document Converter]
        CONFIG[Configuration Manager]
        HISTORY[History Tracker]
        
        subgraph "Conversion Engine"
            PDF[PDF Handler]
            OFFICE[Office Handler<br/>DOCX/XLSX/PPTX]
            IMAGE[Image Handler]
            WEB[HTML Handler]
            AUDIO[Audio Handler]
        end
    end
    
    subgraph "External Services"
        subgraph "Optional Enhancements"
            LLM[LLM API<br/>GPT-4/Claude]
            AZURE[Azure Document<br/>Intelligence]
        end
        
        subgraph "Processing Features"
            OCR[OCR Engine]
            TABLE_EXTRACT[Table Extractor]
            META[Metadata Parser]
        end
    end
    
    subgraph "Storage Layer"
        FS[File System]
        CACHE[Cache Storage<br/>Optional]
        OUTPUT[Output Directory]
    end
    
    subgraph "Integration Points"
        ORCA[OrcaFlex Agent]
        DOC_AGENT[Documentation Agent]
        TEST_AGENT[Testing Agent]
    end
    
    %% Client connections
    CLI --> MCP
    API --> MCP
    AGENTS --> MCP
    
    %% MCP to FastMCP
    MCP --> FASTMCP
    FASTMCP --> ASYNC
    ASYNC --> ROUTER
    
    %% Router to Resources
    ROUTER --> RES_CAP
    ROUTER --> RES_HIST
    ROUTER --> RES_CFG
    
    %% Router to Tools
    ROUTER --> TOOL_CONV
    ROUTER --> TOOL_BATCH
    ROUTER --> TOOL_TABLE
    ROUTER --> TOOL_IMG
    
    %% Router to Prompts
    ROUTER --> PROMPT_TECH
    ROUTER --> PROMPT_TABLE
    ROUTER --> PROMPT_SCAN
    
    %% Tools to Converter
    TOOL_CONV --> CONVERTER
    TOOL_BATCH --> CONVERTER
    TOOL_TABLE --> CONVERTER
    TOOL_IMG --> CONVERTER
    
    %% Converter to Handlers
    CONVERTER --> PDF
    CONVERTER --> OFFICE
    CONVERTER --> IMAGE
    CONVERTER --> WEB
    CONVERTER --> AUDIO
    
    %% Configuration flow
    CONFIG --> CONVERTER
    CONFIG --> FASTMCP
    
    %% History tracking
    TOOL_CONV --> HISTORY
    TOOL_BATCH --> HISTORY
    RES_HIST --> HISTORY
    
    %% External service connections
    CONVERTER -.-> LLM
    CONVERTER -.-> AZURE
    PDF --> OCR
    OFFICE --> TABLE_EXTRACT
    CONVERTER --> META
    
    %% Storage connections
    FS --> CONVERTER
    CONVERTER --> OUTPUT
    CONVERTER -.-> CACHE
    
    %% Agent integrations
    MCP -.-> ORCA
    MCP -.-> DOC_AGENT
    MCP -.-> TEST_AGENT
    
    %% Styling
    classDef client fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef mcp fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef fastmcp fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef core fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef external fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef storage fill:#f5f5f5,stroke:#424242,stroke-width:2px
    classDef agent fill:#e0f2f1,stroke:#004d40,stroke-width:2px
    
    class CLI,API,AGENTS client
    class MCP,RES_CAP,RES_HIST,RES_CFG,TOOL_CONV,TOOL_BATCH,TOOL_TABLE,TOOL_IMG,PROMPT_TECH,PROMPT_TABLE,PROMPT_SCAN mcp
    class FASTMCP,ASYNC,ROUTER fastmcp
    class CONVERTER,CONFIG,HISTORY,PDF,OFFICE,IMAGE,WEB,AUDIO core
    class LLM,AZURE,OCR,TABLE_EXTRACT,META external
    class FS,CACHE,OUTPUT storage
    class ORCA,DOC_AGENT,TEST_AGENT agent