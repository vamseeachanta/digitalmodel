<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrcaFlex Results Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        h1 {
            font-size: 20px;
            font-weight: 500;
            color: #333;
            margin-bottom: 25px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
        }
        
        .folder-selection {
            margin-bottom: 30px;
        }
        
        .folder-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .folder-row label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }
        
        .folder-select-wrapper {
            flex: 1;
            max-width: 300px;
        }
        
        select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        select:hover {
            border-color: #999;
        }
        
        select:focus {
            outline: none;
            border-color: #5e72e4;
            box-shadow: 0 0 0 3px rgba(94, 114, 228, 0.1);
        }
        
        .inline-buttons {
            display: flex;
            gap: 8px;
        }
        
        button {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: #5e72e4;
            color: white;
        }
        
        .btn-primary:hover {
            background: #4c63d2;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(94, 114, 228, 0.3);
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-success:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .config-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .config-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .config-row:last-child {
            margin-bottom: 0;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .form-group select,
        .form-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        .environment-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .charts-container {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }
        
        .chart-wrapper {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .status-message {
            padding: 12px 16px;
            border-radius: 4px;
            margin: 20px 0;
            font-size: 13px;
            display: none;
        }
        
        .status-message.show {
            display: block;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .max-force-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
        
        .max-force-info h3 {
            color: #1565c0;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .max-force-info p {
            font-size: 13px;
            color: #333;
            margin: 5px 0;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5e72e4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Vessel type selector styles */
        .vessel-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .vessel-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: #666;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            bottom: -2px;
        }
        
        .vessel-tab:hover {
            color: #333;
            background: #f8f9fa;
        }
        
        .vessel-tab.active {
            color: #5e72e4;
            border-bottom-color: #5e72e4;
            background: white;
        }
        
        .vessel-content {
            display: none;
        }
        
        .vessel-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Select Loading Condition</h1>
        
        <!-- Folder Selection with inline buttons -->
        <div class="folder-selection">
            <label>Select Analysis Folder:</label>
            <div class="folder-row">
                <div class="folder-select-wrapper">
                    <select id="subfolderSelect">
                        <option value="">Select a folder...</option>
                    </select>
                </div>
                <div class="inline-buttons">
                    <button class="btn-primary" onclick="loadData()">
                        ðŸ“Š Load Data (Auto Max Strut)
                    </button>
                    <button class="btn-success" onclick="refreshAll()">
                        âŸ³ Refresh
                    </button>
                    <button class="btn-secondary" onclick="clearCharts()">
                        âœ– Clear
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Vessel Type Tabs -->
        <div class="vessel-tabs">
            <button class="vessel-tab active" onclick="selectVesselType('FST')">FST</button>
            <button class="vessel-tab" onclick="selectVesselType('LNGC')">LNGC</button>
            <button class="vessel-tab" onclick="selectVesselType('CUSTOM')">Custom</button>
        </div>
        
        <!-- FST Configuration Section -->
        <div id="fstContent" class="vessel-content active">
            <div class="section">
                <div class="section-title">FST Configuration</div>
                <div class="config-group">
                    <div class="config-row">
                        <div class="form-group">
                            <label>FST1 Loading:</label>
                            <select id="fst1Loading">
                                <option value="15">15% LNG</option>
                                <option value="95">95% LNG</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>FST2 Loading:</label>
                            <select id="fst2Loading">
                                <option value="15">15% LNG</option>
                                <option value="95">95% LNG</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Mooring Status:</label>
                            <select id="mooringStatus">
                                <option value="intact">Intact</option>
                                <option value="damaged">Damaged</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- LNGC Configuration Section -->
        <div id="lngcContent" class="vessel-content">
            <div class="section">
                <div class="section-title">LNGC Configuration</div>
                <div class="config-group">
                    <div class="config-row">
                        <div class="form-group">
                            <label>Vessel Capacity:</label>
                            <select id="lngcCapacity">
                                <option value="125000">125,000 mÂ³</option>
                                <option value="180000">180,000 mÂ³</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Loading Condition:</label>
                            <select id="lngcLoading">
                                <option value="ballast">Ballast (10%)</option>
                                <option value="partial">Partial (50%)</option>
                                <option value="laden">Laden (95%)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Berthing Side:</label>
                            <select id="lngcBerthing">
                                <option value="port">Port</option>
                                <option value="starboard">Starboard</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Custom Configuration Section -->
        <div id="customContent" class="vessel-content">
            <div class="section">
                <div class="section-title">Custom Configuration</div>
                <div class="config-group">
                    <div class="config-row">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>File Pattern:</label>
                            <input type="text" id="customPattern" placeholder="Enter custom file pattern...">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Environment Section -->
        <div class="section">
            <div class="section-title">Environment</div>
            <div class="config-group">
                <div class="environment-section">
                    <div class="form-group">
                        <label>Environment Type:</label>
                        <select id="envType">
                            <option value="colinear">Colinear</option>
                            <option value="non-colinear">Non-colinear</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Return Period:</label>
                        <select id="returnPeriod">
                            <option value="5yr">5 Year</option>
                            <option value="10yr">10 Year</option>
                            <option value="100yr">100 Year</option>
                            <option value="1000yr">1000 Year</option>
                        </select>
                    </div>
                </div>
                <div class="environment-section" style="margin-top: 15px;">
                    <div class="form-group">
                        <label>Tide:</label>
                        <select id="tide">
                            <option value="hwl">HWL (High Water Level)</option>
                            <option value="mwl">MWL (Mean Water Level)</option>
                            <option value="lwl">LWL (Low Water Level)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Environment Heading:</label>
                        <select id="heading">
                            <option value="0">0Â°</option>
                            <option value="45">45Â°</option>
                            <option value="90">90Â°</option>
                            <option value="135">135Â°</option>
                            <option value="180">180Â°</option>
                            <option value="225">225Â°</option>
                            <option value="270">270Â°</option>
                            <option value="315">315Â°</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn-success" onclick="loadDataManual()" style="padding: 10px 24px;">
                ðŸŽ¯ Load Data (Manual Config)
            </button>
            <button class="btn-success" onclick="refreshAll()" style="padding: 10px 24px;">
                âŸ³ Refresh
            </button>
            <button class="btn-secondary" onclick="clearCharts()" style="padding: 10px 24px;">
                âœ– Clear
            </button>
        </div>
        
        <!-- Status Message -->
        <div id="statusMessage" class="status-message"></div>
        
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading data...</p>
        </div>
        
        <!-- Charts Container -->
        <div id="charts" class="charts-container"></div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentVesselType = 'FST';
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadSubfolders();
        });
        
        function selectVesselType(type) {
            // Update tabs
            document.querySelectorAll('.vessel-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.vessel-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${type.toLowerCase()}Content`).classList.add('active');
            
            currentVesselType = type;
        }
        
        async function loadSubfolders() {
            try {
                const response = await fetch(`${API_BASE}/subfolders`);
                const data = await response.json();
                
                const select = document.getElementById('subfolderSelect');
                select.innerHTML = '<option value="">Select a folder...</option>';
                
                if (data.subfolders) {
                    data.subfolders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder;
                        option.textContent = folder;
                        select.appendChild(option);
                    });
                    showStatus(`Loaded ${data.subfolders.length} folders`, 'success');
                }
            } catch (error) {
                console.error('Error loading subfolders:', error);
                showStatus('Failed to load folders', 'error');
            }
        }
        
        async function refreshAll() {
            showStatus('Refreshing configuration...', 'info');
            await loadSubfolders();
            showStatus('Configuration refreshed', 'success');
        }
        
        async function loadData() {
            const subfolder = document.getElementById('subfolderSelect').value;
            if (!subfolder) {
                showStatus('Please select a folder', 'error');
                return;
            }
            
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('charts').innerHTML = '';
            
            showStatus('Scanning for maximum strut force...', 'info');
            
            try {
                // Call the max strut force API
                const maxResponse = await fetch(`${API_BASE}/max_strut_force?subfolder=${subfolder}`);
                const maxConfig = await maxResponse.json();
                
                if (maxConfig.error) {
                    throw new Error(maxConfig.error);
                }
                
                console.log('Max strut force configuration:', maxConfig);
                
                showStatus(`Found max strut force: ${maxConfig.max_force.toFixed(2)} N in ${maxConfig.filename}`, 'success');
                
                // Update UI controls based on max config
                if (maxConfig.vesselType === 'FST') {
                    selectVesselType('FST');
                    if (maxConfig.fst1) document.getElementById('fst1Loading').value = maxConfig.fst1;
                    if (maxConfig.fst2) document.getElementById('fst2Loading').value = maxConfig.fst2;
                }
                
                if (maxConfig.tide) document.getElementById('tide').value = maxConfig.tide;
                if (maxConfig.heading) document.getElementById('heading').value = maxConfig.heading;
                if (maxConfig.envType) document.getElementById('envType').value = maxConfig.envType;
                
                // Display info panel
                const infoDiv = document.createElement('div');
                infoDiv.className = 'max-force-info';
                infoDiv.innerHTML = `
                    <h3>Maximum Strut Force Configuration</h3>
                    <p><strong>File:</strong> ${maxConfig.filename}</p>
                    <p><strong>Max Force:</strong> ${maxConfig.max_force.toFixed(2)} N</p>
                    <p><strong>Force Column:</strong> ${maxConfig.force_column}</p>
                    <p><strong>Related Files:</strong> ${maxConfig.total_files || 0} files found</p>
                `;
                
                const chartsDiv = document.getElementById('charts');
                chartsDiv.appendChild(infoDiv);
                
                // Load data for this configuration
                showStatus('Loading all data for maximum force configuration...', 'info');
                
                let params = {
                    subfolder: subfolder,
                    tide: maxConfig.tide || document.getElementById('tide').value,
                    heading: maxConfig.heading || document.getElementById('heading').value,
                    envType: maxConfig.envType || document.getElementById('envType').value,
                    vesselType: maxConfig.vesselType || currentVesselType
                };
                
                if (maxConfig.vesselType === 'FST') {
                    params.fst1 = maxConfig.fst1 || document.getElementById('fst1Loading').value;
                    params.fst2 = maxConfig.fst2 || document.getElementById('fst2Loading').value;
                    params.mooring = document.getElementById('mooringStatus').value;
                }
                
                const queryString = new URLSearchParams(params).toString();
                const response = await fetch(`${API_BASE}/data?${queryString}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                plotData(data);
                showStatus(`Loaded data from ${data.filename} (max strut force configuration)`, 'success');
            } catch (error) {
                console.error('Error loading data:', error);
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }
        
        async function loadDataManual() {
            const subfolder = document.getElementById('subfolderSelect').value;
            if (!subfolder) {
                showStatus('Please select a folder', 'error');
                return;
            }
            
            let params = {
                subfolder: subfolder,
                tide: document.getElementById('tide').value,
                heading: document.getElementById('heading').value,
                envType: document.getElementById('envType').value,
                vesselType: currentVesselType
            };
            
            if (currentVesselType === 'FST') {
                params.fst1 = document.getElementById('fst1Loading').value;
                params.fst2 = document.getElementById('fst2Loading').value;
                params.mooring = document.getElementById('mooringStatus').value;
            } else if (currentVesselType === 'LNGC') {
                params.capacity = document.getElementById('lngcCapacity').value;
                params.loading = document.getElementById('lngcLoading').value;
                params.berthing = document.getElementById('lngcBerthing').value;
            }
            
            const queryString = new URLSearchParams(params).toString();
            
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('charts').innerHTML = '';
            
            try {
                const response = await fetch(`${API_BASE}/data?${queryString}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                plotData(data);
                showStatus(`Loaded data from ${data.filename} (manual configuration)`, 'success');
            } catch (error) {
                console.error('Error loading data:', error);
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }
        
        function plotData(data) {
            const chartsDiv = document.getElementById('charts');
            const infoDiv = chartsDiv.querySelector('.max-force-info');
            if (!infoDiv) {
                chartsDiv.innerHTML = '';
            }
            
            let chartsCreated = false;
            
            // Priority order: Jacket forces first, then strut forces, then mooring
            
            // 1. Jacket Forces (at the top)
            if (data.jacket && Object.keys(data.jacket).length > 0) {
                createChart('Jacket Forces', data.time, data.jacket, 'jacketChart');
                chartsCreated = true;
            }
            
            // 2. Strut Forces - Separate FST1 and FST2
            if (data.struts && Object.keys(data.struts).length > 0) {
                // Separate struts into FST1 (1-4) and FST2 (5-8)
                const fst1Struts = {};
                const fst2Struts = {};
                
                Object.entries(data.struts).forEach(([key, values]) => {
                    // Check if key contains a number
                    const match = key.match(/[1-8]/);
                    if (match) {
                        const strutNum = parseInt(match[0]);
                        if (strutNum >= 1 && strutNum <= 4) {
                            fst1Struts[key] = values;
                        } else if (strutNum >= 5 && strutNum <= 8) {
                            fst2Struts[key] = values;
                        } else {
                            fst1Struts[key] = values; // Default to FST1
                        }
                    } else {
                        // If no number found, try to determine from name
                        if (key.toLowerCase().includes('fst2')) {
                            fst2Struts[key] = values;
                        } else {
                            fst1Struts[key] = values;
                        }
                    }
                });
                
                if (Object.keys(fst1Struts).length > 0) {
                    createChart('FST1 Strut Forces (1-4)', data.time, fst1Struts, 'fst1StrutChart');
                    chartsCreated = true;
                }
                
                if (Object.keys(fst2Struts).length > 0) {
                    createChart('FST2 Strut Forces (5-8)', data.time, fst2Struts, 'fst2StrutChart');
                    chartsCreated = true;
                }
            }
            
            // 3. Mooring Lines (after struts and jacket)
            if (data.lines && Object.keys(data.lines).length > 0) {
                createChart('Mooring Line Tensions', data.time, data.lines, 'linesChart');
                chartsCreated = true;
            }
            
            // 4. Other Forces
            if (data.forces && Object.keys(data.forces).length > 0) {
                // Check if these are strut forces that weren't categorized
                const strutForces = {};
                const otherForces = {};
                
                Object.entries(data.forces).forEach(([key, values]) => {
                    if (key.toLowerCase().includes('strut')) {
                        strutForces[key] = values;
                    } else {
                        otherForces[key] = values;
                    }
                });
                
                if (Object.keys(strutForces).length > 0) {
                    // Separate FST1 and FST2 strut forces
                    const fst1Forces = {};
                    const fst2Forces = {};
                    
                    Object.entries(strutForces).forEach(([key, values]) => {
                        const match = key.match(/[1-8]/);
                        if (match) {
                            const strutNum = parseInt(match[0]);
                            if (strutNum >= 1 && strutNum <= 4) {
                                fst1Forces[key] = values;
                            } else if (strutNum >= 5 && strutNum <= 8) {
                                fst2Forces[key] = values;
                            }
                        }
                    });
                    
                    if (Object.keys(fst1Forces).length > 0) {
                        createChart('FST1 Strut Forces (1-4)', data.time, fst1Forces, 'fst1ForceChart');
                        chartsCreated = true;
                    }
                    
                    if (Object.keys(fst2Forces).length > 0) {
                        createChart('FST2 Strut Forces (5-8)', data.time, fst2Forces, 'fst2ForceChart');
                        chartsCreated = true;
                    }
                }
                
                if (Object.keys(otherForces).length > 0) {
                    createChart('Other Forces', data.time, otherForces, 'forcesChart');
                    chartsCreated = true;
                }
            }
            
            // 5. Motion data
            if (data.motion && Object.keys(data.motion).length > 0) {
                createChart('Vessel Motion', data.time, data.motion, 'motionChart');
                chartsCreated = true;
            }
            
            // 6. Any other data
            if (!chartsCreated && data.other && Object.keys(data.other).length > 0) {
                createChart('Additional Data', data.time, data.other, 'dataChart');
            }
        }
        
        function createChart(title, time, dataDict, divId) {
            const wrapper = document.createElement('div');
            wrapper.className = 'chart-wrapper';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'chart-title';
            titleDiv.textContent = title;
            wrapper.appendChild(titleDiv);
            
            const chartDiv = document.createElement('div');
            chartDiv.id = divId;
            wrapper.appendChild(chartDiv);
            
            document.getElementById('charts').appendChild(wrapper);
            
            const traces = [];
            Object.entries(dataDict).forEach(([key, values]) => {
                traces.push({
                    x: time,
                    y: values,
                    name: key,
                    type: 'scatter',
                    mode: 'lines'
                });
            });
            
            const layout = {
                xaxis: { title: 'Time (s)' },
                yaxis: { title: 'Value' },
                height: 400,
                margin: { t: 20, r: 20, b: 50, l: 60 }
            };
            
            Plotly.newPlot(divId, traces, layout);
        }
        
        function clearCharts() {
            document.getElementById('charts').innerHTML = '';
            showStatus('Charts cleared', 'info');
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type} show`;
            
            setTimeout(() => {
                statusDiv.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>